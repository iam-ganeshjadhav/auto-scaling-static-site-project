node {

    def INSTANCES = ""     // â† FIXED HERE

    stage('Find EC2 Instances in ASG') {
        withCredentials([
            [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'awscreds']
        ]) {
            script {
                INSTANCES = sh(
                    script: """
                        aws autoscaling describe-auto-scaling-groups \
                        --auto-scaling-group-names auto-scaling-static-site-asg \
                        --query "AutoScalingGroups[0].Instances[*].InstanceId" \
                        --output text \
                        --region ap-south-1
                    """,
                    returnStdout: true
                ).trim()

                echo "ASG Instances: ${INSTANCES}"
            }
        }
    }

    stage('Deploy Website to EC2 Instances') {
        withCredentials([
            [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'awscreds']
        ]) {
            script {

                if (!INSTANCES?.trim()) {
                    error "No EC2 instances found!"
                }

                def instanceList = INSTANCES.split()

                instanceList.each { instanceId ->
                    echo "Deploying to instance: ${instanceId}"
                }

            }
        }
    }

}
