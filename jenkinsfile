stage('Deploy Website to EC2 Instances') {

    withCredentials([
        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'awscreds']
    ]) {

        script {
            if (!INSTANCES?.trim()) {
                error "No EC2 instances found in ASG!"
            }

            def instanceList = INSTANCES.split()

            instanceList.each { instanceId ->

                echo "Deploying to instance: ${instanceId}"

                def PUBLIC_IP = sh(
                    script: """
                        aws ec2 describe-instances \
                        --instance-ids ${instanceId} \
                        --query "Reservations[0].Instances[0].PublicIpAddress" \
                        --output text \
                        --region ap-south-1
                    """,
                    returnStdout: true
                ).trim()

                echo "Instance Public IP: ${PUBLIC_IP}"

                if (!PUBLIC_IP || PUBLIC_IP == "None") {
                    echo "Skipping instance ${instanceId} (no public IP)"
                    return
                }

                sh """
                    scp -o StrictHostKeyChecking=no -i /var/lib/jenkins/keys/mykey.pem index.html ec2-user@${PUBLIC_IP}:/var/www/html/
                """

                echo "Deployment complete for instance: ${instanceId}"
            }
        }
    }
}
